---
import "../styles/global.css";
import Hero from "../components/Hero.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import ContactModal from "../components/ContactModal.astro";
import type { ThemeName } from "../types";

interface Props {
  title?: string;
  theme?: ThemeName;
  firstSectionTheme?: ThemeName;
}

const { title = "Portfolio", theme = "ca-va-trailer", firstSectionTheme } = Astro.props;
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    
    <!-- Préchargement des fonts critiques -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="dns-prefetch" href="https://portfolio.bryan-thierry.fr" />
    
    <!-- Préchargement des assets critiques -->
    <link rel="preload" as="image" href="/avatar/footer.webp" fetchpriority="high" />
    
    <!-- Script CRITIQUE EN PREMIER pour éviter tout flash -->
    <script is:inline define:vars={{ pageTheme: theme, initialHeaderTheme: firstSectionTheme }}>
      // EXÉCUTÉ AVANT TOUT LE RESTE DU HTML
      (function () {
        const isHomePage = window.location.pathname === "/" || window.location.pathname === "/index.html";
        
        // Détecter le mode sombre IMMÉDIATEMENT
        let isDark = localStorage.getItem("darkMode") === "true";
        if (localStorage.getItem("darkMode") === null) {
          isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          localStorage.setItem("darkMode", isDark ? "true" : "false");
        }
        
        // Appliquer le thème AVANT que le HTML soit rendu
        let finalTheme;
        if (isHomePage) {
          finalTheme = pageTheme;
          document.documentElement.setAttribute("data-user-dark-mode", isDark ? "true" : "false");
        } else {
          finalTheme = isDark ? pageTheme + "-dark" : pageTheme;
        }
        
        document.documentElement.setAttribute("data-theme", finalTheme);
        localStorage.setItem("theme", finalTheme);
        
        // Stocker l'état isDark pour le toggle
        window.__isDarkMode = isDark;

        // Fonction globale pour changer le thème
        window.changeTheme = function () {
          const isHome =
            window.location.pathname === "/" ||
            window.location.pathname === "/index.html";
          let currentTheme;

          if (isHome) {
            // Sur la page d'accueil, lire la préférence utilisateur
            const userDarkMode =
              document.documentElement.getAttribute("data-user-dark-mode") ===
              "true";
            const baseTheme =
              document.documentElement.getAttribute("data-theme");
            currentTheme = userDarkMode ? baseTheme + "-dark" : baseTheme;
          } else {
            currentTheme =
              document.documentElement.getAttribute("data-theme") ||
              defaultTheme;
          }

          const isDark = currentTheme.includes("-dark");
          const newTheme = isDark
            ? currentTheme.replace("-dark", "")
            : currentTheme + "-dark";

          // Sauvegarder la préférence dark/light (pas le thème spécifique)
          localStorage.setItem(
            "darkMode",
            newTheme.includes("-dark") ? "true" : "false"
          );
          localStorage.setItem("theme", newTheme);

          if (isHome) {
            // Page d'accueil : garder le thème clair pour le contenu, mais mettre à jour la préférence
            document.documentElement.setAttribute(
              "data-user-dark-mode",
              newTheme.includes("-dark") ? "true" : "false"
            );
          } else {
            // Autres pages : appliquer le thème complet
            document.documentElement.setAttribute("data-theme", newTheme);

            // Forcer le recalcul des variables CSS
            document.body.style.display = "none";
            document.body.offsetHeight;
            document.body.style.display = "";

            // Mettre à jour les sections avec data-theme (chaque section garde son propre thème)
            const sections = document.querySelectorAll("section[data-theme]");
            sections.forEach((section) => {
              const sectionTheme = section.getAttribute("data-theme");
              const sectionBaseTheme = sectionTheme.replace("-dark", "");
              const newSectionTheme = newTheme.includes("-dark")
                ? sectionBaseTheme + "-dark"
                : sectionBaseTheme;
              section.setAttribute("data-theme", newSectionTheme);
            });
          }

          // Mettre à jour header et footer (sur TOUTES les pages)
          const header = document.getElementById("header");
          const footer = document.getElementById("footer");

          if (header) {
            // Le header prend le newTheme (qui peut être celui de la section ou de la page)
            header.setAttribute("data-theme", newTheme);

            // Forcer la mise à jour immédiate du background du header
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                const headerComputedStyle = getComputedStyle(header);
                const bgColor = headerComputedStyle
                  .getPropertyValue("--b1")
                  .trim();
                if (header.classList.contains("scrolled") || !isHome) {
                  header.style.backgroundColor = `${bgColor}f5`;
                }

                // Sur la page d'accueil, forcer la mise à jour des couleurs du texte
                if (isHome) {
                  const isDarkMode = newTheme.includes("-dark");
                  const logoLink = header.querySelector(".logo-link");
                  const navLinks = header.querySelectorAll(".nav-link");

                  if (isDarkMode) {
                    if (logoLink) logoLink.style.color = "white";
                    navLinks.forEach((link) => (link.style.color = "white"));
                  } else {
                    if (logoLink) logoLink.style.color = "";
                    navLinks.forEach((link) => (link.style.color = ""));
                  }
                }
              });
            });
          }

          if (footer) {
            // Le footer prend toujours le thème de la page (pageTheme), pas celui du header
            const isDarkForFooter = newTheme.includes("-dark");
            const footerTheme = isDarkForFooter ? pageTheme + "-dark" : pageTheme;
            footer.setAttribute("data-theme", footerTheme);
          }

          // Mettre à jour les icônes du toggle
          const sunIcon = document.querySelector(".sun-icon");
          const moonIcon = document.querySelector(".moon-icon");

          if (!isDark) {
            sunIcon?.classList.add("hidden");
            moonIcon?.classList.remove("hidden");
          } else {
            sunIcon?.classList.remove("hidden");
            moonIcon?.classList.add("hidden");
          }

          // Déclencher un événement custom pour notifier les composants
          window.dispatchEvent(
            new CustomEvent("themeChanged", { detail: { theme: newTheme } })
          );

          return newTheme;
        };

        // Au chargement, synchroniser header et footer avec le bon thème
        window.addEventListener("DOMContentLoaded", function () {
          const isHome =
            window.location.pathname === "/" ||
            window.location.pathname === "/index.html";
          const header = document.getElementById("header");
          const footer = document.getElementById("footer");
          const isDarkMode = localStorage.getItem("darkMode") === "true";

          let themeForHeaderFooter;
          if (isHome) {
            // Sur la page d'accueil, utiliser la préférence utilisateur pour header/footer
            const userDarkMode =
              document.documentElement.getAttribute("data-user-dark-mode") ===
              "true";
            const baseTheme =
              document.documentElement.getAttribute("data-theme");
            themeForHeaderFooter = userDarkMode
              ? baseTheme + "-dark"
              : baseTheme;
          } else {
            // Si un thème initial pour le header est spécifié (comme sur la page à propos)
            if (typeof initialHeaderTheme !== 'undefined' && initialHeaderTheme) {
              themeForHeaderFooter = isDarkMode ? initialHeaderTheme + "-dark" : initialHeaderTheme;
            } else {
              themeForHeaderFooter =
                document.documentElement.getAttribute("data-theme");
            }

            // Sur les autres pages, mettre à jour chaque section avec son propre thème
            const sections = document.querySelectorAll("section[data-theme]");
            sections.forEach((section) => {
              const sectionTheme = section.getAttribute("data-theme");
              const sectionBaseTheme = sectionTheme.replace("-dark", "");
              const newSectionTheme = isDarkMode
                ? sectionBaseTheme + "-dark"
                : sectionBaseTheme;
              section.setAttribute("data-theme", newSectionTheme);
            });
          }

          if (header) {
            header.setAttribute("data-theme", themeForHeaderFooter);

            // Sur la page d'accueil en mode sombre, mettre le texte en blanc
            if (isHome && themeForHeaderFooter.includes("-dark")) {
              const logoLink = header.querySelector(".logo-link");
              const navLinks = header.querySelectorAll(".nav-link");

              if (logoLink) logoLink.style.color = "white";
              navLinks.forEach((link) => (link.style.color = "white"));
            }
          }

          // Le footer prend toujours le thème de la page, pas celui du header
          const themeForFooter = isDarkMode ? pageTheme + "-dark" : pageTheme;
          if (footer) footer.setAttribute("data-theme", themeForFooter);

          // Initialiser les icônes
          const isDark = themeForHeaderFooter.includes("-dark");
          const sunIcon = document.querySelector(".sun-icon");
          const moonIcon = document.querySelector(".moon-icon");

          if (isDark) {
            sunIcon?.classList.add("hidden");
            moonIcon?.classList.remove("hidden");
          } else {
            sunIcon?.classList.remove("hidden");
            moonIcon?.classList.add("hidden");
          }
        });
      })();
    </script>
    
    <!-- Précharger les scripts critiques de navigation -->
    <link rel="modulepreload" href="/src/scripts/projet-navigation.ts" />
  </head>
  <body class="overflow-x-hidden">
    <Header theme={theme} />
    <slot />
    <Footer theme={theme} />
    <ContactModal />
  </body>
</html>
