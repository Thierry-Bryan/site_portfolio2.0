---
import Button from "./Button.astro";
import ThemeToggle from "./ThemeToggle.astro";
import { navigationConfig } from "../config";
import type { ThemeName } from "../types";

interface Props {
  theme?: ThemeName;
}

const { theme = "ca-va-trailer" } = Astro.props;
const isProjetsPageSSR =
  Astro.url.pathname === "/projets" ||
  Astro.url.pathname.startsWith("/projets/");
const isLegalPageSSR =
  Astro.url.pathname.includes("/mentions-legales") ||
  Astro.url.pathname.includes("/politique-confidentialite");
const isServicesPageSSR = Astro.url.pathname.includes("/services");
const pageClass = isProjetsPageSSR
  ? "projet-page"
  : isLegalPageSSR
    ? "legal-page"
    : isServicesPageSSR
      ? "services-page"
      : "";
const headerClass =
  `navbar w-full px-6 py-4 fixed top-0 z-50 transition-all duration-500 bg-transparent ${pageClass}`.trim();
---

<!-- Mobile Menu Backdrop -->
<div
  id="mobile-menu-backdrop"
  class="fixed inset-0 z-[999] bg-black bg-opacity-50 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"
></div>

<!-- Mobile Menu -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-[1000] bg-[var(--b1)] transform translate-x-full transition-transform duration-300 ease-in-out md:hidden overflow-y-auto"
>
  <div class="flex items-center justify-between px-6 py-4 border-b-2 border-[var(--bc)] border-opacity-10">
    <a
      href="/"
      class="logo-link font-primary text-4xl tracking-tight relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover"
    >
      BRYAN THIERRY
    </a>
    <button
      id="mobile-menu-close"
      class="p-2 rounded-lg transition-colors duration-300 hover:bg-[var(--p)] hover:bg-opacity-10"
      aria-label="Fermer le menu"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2.5"
          d="M6 18L18 6M6 6l12 12"
        ></path>
      </svg>
    </button>
  </div>
  
  <nav class="flex flex-col h-[calc(100%-80px)] px-6 py-8 justify-center">
    <ul class="space-y-6 mb-12">
      <li>
        <a
          href="/"
          class="mobile-nav-link font-primary text-2xl block py-3 transition-all duration-300 hover:scale-105 hover:-rotate-1 text-[var(--bc)]"
        >
          ACCUEIL
        </a>
      </li>
      <li>
        <a
          href="/services"
          class="mobile-nav-link font-primary text-2xl block py-3 transition-all duration-300 hover:scale-105 hover:-rotate-1 text-[var(--bc)]"
        >
          MES SERVICES
        </a>
      </li>
      <li>
        <a
          href="/projets"
          class="mobile-nav-link font-primary text-2xl block py-3 transition-all duration-300 hover:scale-105 hover:-rotate-1 text-[var(--bc)]"
        >
          MES PROJETS
        </a>
      </li>
      <li>
        <a
          href="/a-propos"
          class="mobile-nav-link font-primary text-2xl block py-3 transition-all duration-300 hover:scale-105 hover:-rotate-1 text-[var(--bc)]"
        >
          A PROPOS
        </a>
      </li>
    </ul>
    
    <button
      onclick="window.openContactModal(); document.getElementById('mobile-menu').classList.add('translate-x-full'); document.getElementById('mobile-menu-backdrop').classList.add('opacity-0', 'pointer-events-none'); document.body.style.overflow = '';"
      class="w-full font-primary relative inline-flex h-11 px-8 items-center justify-center overflow-hidden cursor-pointer transition-all duration-200 btn-gradient-primary btn-shadow"
    >
      <span class="btn-text relative z-10 btn-text-white">ME CONTACTER</span>
    </button>
  </nav>
</div>

<header id="header" class={headerClass}>
  <!-- Mobile: Logo + Hamburger -->
  <div class="flex items-center justify-between w-full md:hidden">
    <a
      href="/"
      class="mobile-logo-link logo-link font-primary text-2xl tracking-tight relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover"
    >
      BRYAN THIERRY
    </a>
    
    <div class="flex items-center gap-3">
      <button
        id="mobile-menu-btn"
        class="mobile-hamburger p-2 rounded-lg transition-colors duration-300 hover:bg-[var(--p)] hover:bg-opacity-10"
        aria-label="Menu"
        aria-expanded="false"
      >
        <svg
          class="w-6 h-6 transition-all duration-300"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            class="hamburger-line"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2.5"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Desktop: Logo + Nav + Actions -->
  <div class="hidden md:flex items-center justify-between w-full">
    <div class="navbar-start">
      <a
        href="/"
        class="desktop-logo-link logo-link font-primary text-4xl tracking-tight relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover"
      >
        BRYAN THIERRY
      </a>
    </div>

    <div class="navbar-center">
      <ul class="menu menu-horizontal gap-10 px-1">
        <li>
          <a
            href="/services"
            class="nav-link font-primary uppercase text-xl relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover-link hover:bg-transparent"
          >
            MES SERVICES
          </a>
        </li>
        <li>
          <a
            href="/projets"
            class="nav-link font-primary uppercase text-xl relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover-link hover:bg-transparent"
          >
            MES PROJETS
          </a>
        </li>
        <li>
          <a
            href="/a-propos"
            class="nav-link font-primary uppercase text-xl relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover-link hover:bg-transparent"
          >
            A PROPOS
          </a>
        </li>
      </ul>
    </div>

    <div class="navbar-end flex items-center gap-4">
      <ThemeToggle />
      <button
        onclick="window.openContactModal()"
        aria-label="Me contacter"
        class="header-button font-primary relative inline-flex h-11 px-8 items-center justify-center overflow-hidden cursor-pointer transition-all duration-200 btn-gradient-primary btn-shadow"
      >
        <span class="btn-text relative z-10 btn-text-white">ME CONTACTER</span>
      </button>
    </div>
  </div>
</header>

<script>
  // Gestion du menu mobile
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenuClose = document.getElementById("mobile-menu-close");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileMenuBackdrop = document.getElementById("mobile-menu-backdrop");
  const mobileNavLinks = document.querySelectorAll(".mobile-nav-link");

  function openMobileMenu() {
    mobileMenu?.classList.remove("translate-x-full");
    mobileMenuBackdrop?.classList.remove("opacity-0", "pointer-events-none");
    mobileMenuBtn?.setAttribute("aria-expanded", "true");
    document.body.style.overflow = "hidden";
  }

  function closeMobileMenu() {
    mobileMenu?.classList.add("translate-x-full");
    mobileMenuBackdrop?.classList.add("opacity-0", "pointer-events-none");
    mobileMenuBtn?.setAttribute("aria-expanded", "false");
    document.body.style.overflow = "";
  }

  mobileMenuBtn?.addEventListener("click", () => {
    const isOpen = !mobileMenu?.classList.contains("translate-x-full");
    if (isOpen) {
      closeMobileMenu();
    } else {
      openMobileMenu();
    }
  });

  mobileMenuClose?.addEventListener("click", closeMobileMenu);
  mobileMenuBackdrop?.addEventListener("click", closeMobileMenu);

  // Fermer le menu au clic sur un lien
  mobileNavLinks.forEach(link => {
    link.addEventListener("click", closeMobileMenu);
  });

  // Fermer le menu si on redimensionne vers desktop
  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768) {
      closeMobileMenu();
    }
  });
</script>

<script>
  // @ts-nocheck
  import { getHeaderContrast } from "../config/themes.config";

  let lastScrollY = 0;
  let ticking = false;
  let isInHero = true; // Track si on est dans le hero

  // Détection du type de page
  const isHomePage =
    window.location.pathname === "/" ||
    window.location.pathname === "/index.html";
  const isProjetPage =
    window.location.pathname === "/projets" ||
    window.location.pathname.startsWith("/projets/");
  const isAProposPage = window.location.pathname.includes("/a-propos");

  // Helper pour obtenir le contraste du header
  function getHeaderTextClass() {
    const header = document.getElementById("header");
    if (!header) return "text-[var(--bc)]";
    
    const currentTheme = header.getAttribute("data-theme") || "ca-va-trailer";
    const isDarkMode = localStorage.getItem("darkMode") === "true";
    
    // Simplification : on utilise toujours var(--bc) qui s'adapte automatiquement
    return "text-[var(--bc)]";
  }

  // Appliquer le contraste au header
  function applyHeaderContrast() {
    const header = document.getElementById("header");
    if (!header) return;
    
    const desktopLogo = header.querySelector(".desktop-logo-link");
    const mobileLogo = header.querySelector(".mobile-logo-link");
    const navLinks = header.querySelectorAll(".nav-link");
    const textClass = getHeaderTextClass();
    
    // Appliquer la classe de texte
    if (desktopLogo) desktopLogo.className = desktopLogo.className.replace(/text-\[var\(--\w+\)\]/g, textClass);
    if (mobileLogo) mobileLogo.className = mobileLogo.className.replace(/text-\[var\(--\w+\)\]/g, textClass);
    navLinks.forEach(link => {
      link.className = link.className.replace(/text-\[var\(--\w+\)\]/g, textClass);
    });
    
    // Gérer la couleur du logo desktop selon le mode
    const isDarkMode = localStorage.getItem("darkMode") === "true";
    if (desktopLogo) {
      if (isDarkMode) {
        desktopLogo.style.color = "white";
      } else {
        desktopLogo.style.color = "";
      }
    }
  }

  function updateHeaderStyle() {
    const header = document.getElementById("header");
    if (!header) return;

    const currentScrollY = window.scrollY;
    const scrollingDown = currentScrollY > lastScrollY;
    const scrollingUp = currentScrollY < lastScrollY;

    // Vérifier si on est près du bas de page
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const isNearBottom = currentScrollY + windowHeight >= documentHeight - 100;

    if (isHomePage) {
      // Comportement pour la page d'accueil (logique existante)
      const heroHeight = window.innerHeight;
      const scrolled = currentScrollY > heroHeight - 100;
      const headerButton = document.querySelector(".header-button");
      const mobileHamburger = document.querySelector(".mobile-hamburger");
      const hamburgerSvg = mobileHamburger?.querySelector("svg");

      // Fond avec couleur du thème après le hero
      if (scrolled) {
        header.classList.add("scrolled");
        // Utiliser directement la variable CSS dans rgba
        header.style.backgroundColor =
          "rgba(var(--b1-rgb, 250, 249, 247), 0.96)";
        header.style.backdropFilter = "blur(10px)";
        header.style.boxShadow = "0 2px 10px rgba(0, 0, 0, 0.1)";

        // Hamburger devient noir après le hero
        if (hamburgerSvg) {
          hamburgerSvg.style.color = "var(--bc)";
        }

        // Seulement si on change d'état (hero -> après hero)
        if (isInHero && headerButton) {
          isInHero = false;
          headerButton.classList.remove("hero-button");

          // Forcer la réinitialisation complète des styles
          const textEl = headerButton.querySelector(".btn-text");
          if (textEl) {
            textEl.style.color = "white";
            textEl.style.textShadow = "none";
            // Supprimer les événements hover en cours
            textEl.style.removeProperty("transition");
            setTimeout(() => {
              if (textEl)
                textEl.style.transition =
                  "color 0.3s ease, text-shadow 0.3s ease";
            }, 10);
          }
        }
      } else {
        header.classList.remove("scrolled");
        header.style.backgroundColor = "transparent";
        header.style.backdropFilter = "none";
        header.style.boxShadow = "none";

        // Hamburger devient blanc dans le hero
        if (hamburgerSvg) {
          hamburgerSvg.style.color = "white";
        }

        // Seulement si on change d'état (après hero -> hero)
        if (!isInHero && headerButton) {
          isInHero = true;
          headerButton.classList.add("hero-button");

          // Forcer la réinitialisation complète des styles
          const textEl = headerButton.querySelector(".btn-text");
          if (textEl) {
            textEl.style.color = "#181818";
            textEl.style.textShadow = "none";
            // Supprimer les événements hover en cours
            textEl.style.removeProperty("transition");
            setTimeout(() => {
              if (textEl)
                textEl.style.transition =
                  "color 0.3s ease, text-shadow 0.3s ease";
            }, 10);
          }
        }
      }

      // Animation disparition/apparition
      if (scrolled) {
        // Toujours afficher si on est en bas de page
        if (isNearBottom) {
          header.style.transform = "translateY(0)";
        } else if (scrollingDown && currentScrollY > heroHeight + 100) {
          header.style.transform = "translateY(-100%)";
        } else if (scrollingUp || currentScrollY <= heroHeight + 100) {
          header.style.transform = "translateY(0)";
        }
      } else {
        header.style.transform = "translateY(0)";
      }
    } else if (isProjetPage) {
      // Comportement pour les pages de projets
      const scrollThreshold = 50;

      header.classList.add("scrolled", "projet-page");
      // Utiliser directement la variable CSS dans rgba
      header.style.backgroundColor = "rgba(var(--b1-rgb, 250, 249, 247), 0.96)";
      header.style.backdropFilter = "blur(10px)";

      // Animation disparition/apparition basée sur le scroll
      if (currentScrollY > scrollThreshold) {
        // Toujours afficher si on est en bas de page
        if (isNearBottom) {
          header.style.transform = "translateY(0)";
        } else if (scrollingDown && currentScrollY > lastScrollY + 5) {
          header.style.transform = "translateY(-100%)";
        } else if (scrollingUp) {
          header.style.transform = "translateY(0)";
        }
      } else {
        header.style.transform = "translateY(0)";
      }
    } else if (isAProposPage) {
      // Comportement pour la page à propos avec changement de thème selon la section
      header.classList.add("scrolled", "apropos-page");
      header.style.backdropFilter = "blur(10px)";
      header.style.transform = "translateY(0)"; // Toujours visible

      // Détecter la section visible et extraire le thème de base (sans -dark)
      const sections = document.querySelectorAll("section[data-theme]");
      let currentBaseTheme = null;

      sections.forEach((section) => {
        const rect = section.getBoundingClientRect();
        if (rect.top <= 100 && rect.bottom >= 100) {
          const sectionTheme = section.getAttribute("data-theme") || "";
          currentBaseTheme = sectionTheme.replace("-dark", "");
        }
      });

      // Mettre à jour le thème du header avec le mode sombre si activé
      if (currentBaseTheme) {
        const isDarkMode = localStorage.getItem("darkMode") === "true";
        const headerTheme = isDarkMode
          ? currentBaseTheme + "-dark"
          : currentBaseTheme;
        header.setAttribute("data-theme", headerTheme);

        // Mettre à jour le background avec le nouveau thème
        setTimeout(() => {
          header.style.backgroundColor =
            "rgba(var(--b1-rgb, 250, 249, 247), 0.96)";
          applyHeaderContrast(); // Appliquer le contraste après changement de thème
        }, 10);
      }
    } else {
      // Comportement pour les autres pages
      const scrollThreshold = 50;

      // Toujours fond avec couleur du thème sur les autres pages
      header.classList.add("scrolled");
      // Utiliser directement la variable CSS dans rgba
      header.style.backgroundColor = "rgba(var(--b1-rgb, 250, 249, 247), 0.96)";
      header.style.backdropFilter = "blur(10px)";

      // Animation disparition/apparition basée sur le scroll
      if (currentScrollY > scrollThreshold) {
        // Toujours afficher si on est en bas de page
        if (isNearBottom) {
          header.style.transform = "translateY(0)";
        } else if (scrollingDown && currentScrollY > lastScrollY + 5) {
          header.style.transform = "translateY(-100%)";
        } else if (scrollingUp) {
          header.style.transform = "translateY(0)";
        }
      } else {
        header.style.transform = "translateY(0)";
      }
    }

    lastScrollY = currentScrollY;
  }

  function requestTick() {
    if (!ticking) {
      requestAnimationFrame(updateHeaderStyle);
      ticking = true;
    }
  }

  function onScroll() {
    ticking = false;
    requestTick();
  }

  window.addEventListener("scroll", onScroll);

  // Écouter les changements de thème pour TOUTES les pages
  window.addEventListener("storage", (e) => {
    if (e.key === "darkMode") {
      updateHeaderStyle();
      applyHeaderContrast();
    }
  });

  // Écouter les changements via l'événement custom (pour le même onglet)
  window.addEventListener("themeChanged", () => {
    updateHeaderStyle();
    applyHeaderContrast();
  });

  // Initialisation au chargement
  if (isHomePage) {
    const headerButton = document.querySelector(".header-button");
    const mobileHamburger = document.querySelector(".mobile-hamburger");
    const hamburgerSvg = mobileHamburger?.querySelector("svg");
    
    if (headerButton && window.scrollY <= window.innerHeight - 100) {
      headerButton.classList.add("hero-button");
      const textEl = headerButton.querySelector(".btn-text");
      if (textEl) {
        textEl.style.color = "#181818";
        textEl.style.textShadow = "none";
      }
    }
    
    // Initialiser le hamburger à blanc si on est dans le hero
    if (hamburgerSvg && window.scrollY <= window.innerHeight - 100) {
      hamburgerSvg.style.color = "white";
    }
    
    updateHeaderStyle();
    applyHeaderContrast();
  } else {
    updateHeaderStyle();
    applyHeaderContrast();
  }
</script>
