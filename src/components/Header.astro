---
import Button from "./Button.astro";
import ThemeToggle from "./ThemeToggle.astro";

interface Props {
  theme?: "RBA" | "les-12-fragments" | "orange" | "ca-va-trailer" | "echo-safe" | "omnisphere" | "ocean" | "cyberpunk" | "sunset";
}

const { theme = "ca-va-trailer" } = Astro.props;
const isProjetsPageSSR = Astro.url.pathname === "/projets" || Astro.url.pathname.startsWith("/projets/");
const headerClass = `navbar w-full px-6 py-4 fixed top-0 z-50 transition-all duration-500 bg-transparent ${isProjetsPageSSR ? "projet-page" : ""}`.trim();
---

<header
  id="header"
  class={headerClass}
>
  <div class="navbar-start">
    <a
      href="/"
      class="logo-link font-primary text-4xl tracking-tight relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover"
    >
      BRYAN THIERRY
    </a>
  </div>

  <div class="navbar-center hidden md:flex">
    <ul class="menu menu-horizontal gap-10 px-1">
      <li>
        <a
          href="#services"
          class="nav-link font-primary uppercase text-xl relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover-link hover:bg-transparent"
        >
          MES SERVICES
        </a>
      </li>
      <li>
        <a
          href="#projects"
          class="nav-link font-primary uppercase text-xl relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover-link hover:bg-transparent"
        >
          MES PROJETS
        </a>
      </li>
      <li>
        <a
          href="#about"
          class="nav-link font-primary uppercase text-xl relative transition-all duration-300 hover:scale-105 hover:-rotate-1 comics-glow-hover-link hover:bg-transparent"
        >
          A PROPOS
        </a>
      </li>
    </ul>
  </div>

  <div class="navbar-end flex items-center gap-4">
    <ThemeToggle />
    <Button href="#contact" aria-label="Me contacter" theme={theme} className="header-button">
      ME CONTACTER
    </Button>
  </div>
</header>

<script>
  let lastScrollY = 0;
  let ticking = false;
  let isInHero = true; // Track si on est dans le hero

  // Détection du type de page
  const isHomePage =
    window.location.pathname === "/" ||
    window.location.pathname === "/index.html";
  const isProjetPage = window.location.pathname === "/projets" || window.location.pathname.startsWith("/projets/");
  const isAProposPage = window.location.pathname.includes("/a-propos");

  function updateHeaderStyle() {
    const header = document.getElementById("header");
    if (!header) return;

    const currentScrollY = window.scrollY;
    const scrollingDown = currentScrollY > lastScrollY;
    const scrollingUp = currentScrollY < lastScrollY;
    
    // Vérifier si on est près du bas de page
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    const isNearBottom = currentScrollY + windowHeight >= documentHeight - 100;

    if (isHomePage) {
      // Comportement pour la page d'accueil (logique existante)
      const heroHeight = window.innerHeight;
      const scrolled = currentScrollY > heroHeight - 100;
      const headerButton = document.querySelector(".header-button");

      // Fond avec couleur du thème après le hero
      if (scrolled) {
        header.classList.add("scrolled");
        const headerComputedStyle = getComputedStyle(header);
        const bgColor = headerComputedStyle.getPropertyValue('--b1').trim();
        header.style.backgroundColor = `${bgColor}f5`; // f5 = ~96% opacity (plus opaque)
        header.style.backdropFilter = "blur(10px)";
        header.style.boxShadow = "0 2px 10px rgba(0, 0, 0, 0.1)";
        
        // Seulement si on change d'état (hero -> après hero)
        if (isInHero && headerButton) {
          isInHero = false;
          headerButton.classList.remove("hero-button");
          
          // Forcer la réinitialisation complète des styles
          const textEl = headerButton.querySelector(".btn-text");
          if (textEl) {
            textEl.style.color = "white";
            textEl.style.textShadow = "none";
            // Supprimer les événements hover en cours
            textEl.style.removeProperty("transition");
            setTimeout(() => {
              if (textEl) textEl.style.transition = "color 0.3s ease, text-shadow 0.3s ease";
            }, 10);
          }
        }
      } else {
        header.classList.remove("scrolled");
        header.style.backgroundColor = "transparent";
        header.style.backdropFilter = "none";
        header.style.boxShadow = "none";
        
        // Seulement si on change d'état (après hero -> hero)
        if (!isInHero && headerButton) {
          isInHero = true;
          headerButton.classList.add("hero-button");
          
          // Forcer la réinitialisation complète des styles
          const textEl = headerButton.querySelector(".btn-text");
          if (textEl) {
            textEl.style.color = "#181818";
            textEl.style.textShadow = "none";
            // Supprimer les événements hover en cours
            textEl.style.removeProperty("transition");
            setTimeout(() => {
              if (textEl) textEl.style.transition = "color 0.3s ease, text-shadow 0.3s ease";
            }, 10);
          }
        }
      }

      // Animation disparition/apparition
      if (scrolled) {
        // Toujours afficher si on est en bas de page
        if (isNearBottom) {
          header.style.transform = "translateY(0)";
        } else if (scrollingDown && currentScrollY > heroHeight + 100) {
          header.style.transform = "translateY(-100%)";
        } else if (scrollingUp || currentScrollY <= heroHeight + 100) {
          header.style.transform = "translateY(0)";
        }
      } else {
        header.style.transform = "translateY(0)";
      }
    } else if (isProjetPage) {
      // Comportement pour les pages de projets
      const scrollThreshold = 50;

      header.classList.add("scrolled", "projet-page");
      const headerComputedStyle = getComputedStyle(header);
      const bgColor = headerComputedStyle.getPropertyValue('--b1').trim();
      header.style.backgroundColor = `${bgColor}f5`;
      header.style.backdropFilter = "blur(10px)";

      // Animation disparition/apparition basée sur le scroll
      if (currentScrollY > scrollThreshold) {
        // Toujours afficher si on est en bas de page
        if (isNearBottom) {
          header.style.transform = "translateY(0)";
        } else if (scrollingDown && currentScrollY > lastScrollY + 5) {
          header.style.transform = "translateY(-100%)";
        } else if (scrollingUp) {
          header.style.transform = "translateY(0)";
        }
      } else {
        header.style.transform = "translateY(0)";
      }
    } else if (isAProposPage) {
      // Comportement pour la page à propos avec changement de thème selon la section
      header.classList.add("scrolled", "apropos-page");
      header.style.backdropFilter = "blur(10px)";
      header.style.transform = "translateY(0)"; // Toujours visible

      // Détecter la section visible et extraire le thème de base (sans -dark)
      const sections = document.querySelectorAll("section[data-theme]");
      let currentBaseTheme = null;

      sections.forEach((section) => {
        const rect = section.getBoundingClientRect();
        if (rect.top <= 100 && rect.bottom >= 100) {
          const sectionTheme = section.getAttribute("data-theme") || "";
          currentBaseTheme = sectionTheme.replace("-dark", "");
        }
      });

      // Mettre à jour le thème du header avec le mode sombre si activé
      if (currentBaseTheme) {
        const isDarkMode = localStorage.getItem("darkMode") === "true";
        const headerTheme = isDarkMode ? currentBaseTheme + "-dark" : currentBaseTheme;
        header.setAttribute("data-theme", headerTheme);

        // Mettre à jour le background avec le nouveau thème
        setTimeout(() => {
          const headerComputedStyle = getComputedStyle(header);
          const bgColor = headerComputedStyle.getPropertyValue('--b1').trim();
          header.style.backgroundColor = `${bgColor}f5`;
        }, 10);
      }
    } else {
      // Comportement pour les autres pages
      const scrollThreshold = 50;

      // Toujours fond avec couleur du thème sur les autres pages
      header.classList.add("scrolled");
      const headerComputedStyle = getComputedStyle(header);
      const bgColor = headerComputedStyle.getPropertyValue('--b1').trim();
      header.style.backgroundColor = `${bgColor}f5`;
      header.style.backdropFilter = "blur(10px)";

      // Animation disparition/apparition basée sur le scroll
      if (currentScrollY > scrollThreshold) {
        // Toujours afficher si on est en bas de page
        if (isNearBottom) {
          header.style.transform = "translateY(0)";
        } else if (scrollingDown && currentScrollY > lastScrollY + 5) {
          header.style.transform = "translateY(-100%)";
        } else if (scrollingUp) {
          header.style.transform = "translateY(0)";
        }
      } else {
        header.style.transform = "translateY(0)";
      }
    }

    lastScrollY = currentScrollY;
  }

  function requestTick() {
    if (!ticking) {
      requestAnimationFrame(updateHeaderStyle);
      ticking = true;
    }
  }

  function onScroll() {
    ticking = false;
    requestTick();
  }

  window.addEventListener("scroll", onScroll);
  
  // Écouter les changements de thème pour la page à-propos
  if (isAProposPage) {
    window.addEventListener("storage", (e) => {
      if (e.key === "darkMode") {
        updateHeaderStyle();
      }
    });
    
    // Écouter les changements via l'événement custom (pour le même onglet)
    window.addEventListener("themeChanged", () => {
      updateHeaderStyle();
    });
  }
  
  // Initialisation au chargement
  if (isHomePage) {
    const headerButton = document.querySelector(".header-button");
    if (headerButton && window.scrollY <= window.innerHeight - 100) {
      headerButton.classList.add("hero-button");
      const textEl = headerButton.querySelector(".btn-text");
      if (textEl) {
        textEl.style.color = "#181818";
        textEl.style.textShadow = "none";
      }
    }
  }
  
  updateHeaderStyle();
</script>
