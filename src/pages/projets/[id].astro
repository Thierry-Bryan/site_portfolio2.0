---
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/Button.astro";
import BackgroundComics from "../../components/BackgroundComics.astro";
import ArrowButton from "../../components/ArrowButton.astro";
import {
  getProjets,
  getProjetBySlug,
  getFileUrl,
  getMultipleFileUrls,
  getNextProjet,
  getPreviousProjet,
} from "../../lib/pocketbase.js";

// Générer les routes statiques pour tous les projets
export async function getStaticPaths() {
  const projets = await getProjets();
  return projets.map((projet) => ({
    params: { id: projet.slug },
  }));
}

// Récupérer le slug depuis les paramètres de l'URL
const { id } = Astro.params;

// Récupérer les données du projet
const projet = await getProjetBySlug(id);
const nextProjet = await getNextProjet(id);
const previousProjet = await getPreviousProjet(id);

// Si le projet n'existe pas, rediriger vers la page d'accueil
if (!projet) {
  return Astro.redirect("/");
}

// Récupérer les URLs des images
const heroImageUrl = getFileUrl(projet, projet.hero_image);
const imagesUrls = getMultipleFileUrls(projet, "images");
---

<Layout
  theme={projet.theme as any}
  title={`${projet.title} - Portfolio Bryan Thierry`}
>
  <!-- Hero Section -->
  <section
    class="relative h-[calc(120vh-7rem)] flex items-stretch overflow-hidden"
  >
    <div class="w-full h-full relative">
      <!-- Zone gauche : Texte sur fond avec angle prononcé -->
      <div
        class="absolute left-0 top-0 h-full flex flex-col justify-center pl-12 md:pl-16 lg:pl-20 pr-8 py-12 w-[35%] min-w-[340px] z-30"
      >
        <div
          style="box-shadow: 8px 0 24px rgba(0, 0, 0, 0.2); position: absolute; inset: 0; z-index: -1; clip-path: polygon(0 0, 100% 0, 85% 100%, 0 100%);"
        >
        </div>
        <h1
          class="hero-title text-4xl md:text-5xl lg:text-7xl mb-5 md:mb-6 leading-[0.95] transition-colors duration-700"
          style="color: var(--p); font-style: italic; text-transform: uppercase; transform: rotate(-2deg);"
        >
          {projet.title}
        </h1>
        <p
          class="hero-description text-sm md:text-base lg:text-lg font-medium max-w-md leading-relaxed transition-colors duration-700"
          style="color: var(--bc);"
        >
          {projet.hero_description}
        </p>
      </div>

      <!-- Zone centrale : comics + device -->
      <div
        class="absolute left-[38%] top-0 h-full flex items-center justify-center w-[60%] z-20"
        style="clip-path: polygon(30% 0, 100% 0, 94% 100%, 0 100%);"
        id="hero-center"
      >
        <div
        >
        </div>
        <!-- Background pattern comics -->
        <div
          class="absolute inset-0 w-full h-full overflow-visible transition-all duration-700"
          id="background-comics"
        >
          <BackgroundComics theme={projet.theme as any} />
        </div>
      </div>

      <!-- Device image en absolute qui dépasse -->
      <div class="absolute left-1/2 top-1/2 -translate-x-[70px] -translate-y-1/2 z-22">
        <img
          src={heroImageUrl}
          alt={projet.title}
          class="max-h-[180px] md:max-h-[280px] lg:max-h-[360px] w-auto transition-opacity duration-500"
          style="filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.4));"
          id="hero-device"
        />
      </div>

      <!-- Zone droite : triangle avec angle prononcé -->
      <div
        class="triangle-right absolute right-0 top-0 h-full w-[25%] min-w-[160px] z-25 pointer-events-none transition-all duration-700"
        style="background: var(--p); clip-path: polygon(60% 0, 100% 0, 100% 100%, 0 100%);"
      >
        <div
          style="box-shadow: -8px 0 24px rgba(0, 0, 0, 0.2); position: absolute; inset: 0; z-index: -1; clip-path: polygon(15% 0, 100% 0, 100% 100%, 0 100%);"
        >
        </div>
      </div>

      <!-- Flèches de navigation style comics avec angles -->
      <div
        class="absolute bottom-20 left-[35%] z-40 cursor-pointer"
        id="prev-arrow-wrapper"
        data-prev-projet={previousProjet?.slug || ""}
      >
        <ArrowButton
          direction="prev"
          dataAttribute={previousProjet?.slug || ""}
          theme={projet.theme as any}
        />
      </div>
      <div
        class="absolute bottom-20 right-[17%] z-40 cursor-pointer"
        id="next-arrow-wrapper"
        data-next-projet={nextProjet?.slug || ""}
      >
        <ArrowButton
          direction="next"
          dataAttribute={nextProjet?.slug || ""}
          theme={projet.theme as any}
        />
      </div>
    </div>
  </section>

  <!-- Bandeau de défilement du nom du projet -->
  <section class="bg-black py-4 overflow-hidden border-t-4 border-b-4" style="border-color: var(--p);" id="projet-banner">
    <div class="flex whitespace-nowrap animate-scroll">
      <div class="flex items-center gap-8 pr-8" id="banner-content">
        {Array.from({ length: 20 }).map(() => (
          <>
            <span class="text-white font-primary text-2xl md:text-3xl italic transform -rotate-2 banner-title">
              {projet.title.toUpperCase()}
            </span>
            <span class="text-4xl" style="color: var(--p);">★</span>
          </>
        ))}
      </div>
    </div>
  </section>

  <style>
    @keyframes scroll {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-50%);
      }
    }

    .animate-scroll {
      animation: scroll 30s linear infinite;
    }

    .animate-scroll:hover {
      animation-play-state: paused;
    }
  </style>

  <script
    define:vars={{
      currentTheme: projet.theme,
      allProjets: (await getProjets()).map((p) => ({
        slug: p.slug,
        theme: p.theme,
        backgroundImage: getFileUrl(p, p.hero_image),
        title: p.title.toUpperCase(),
        description: p.hero_description,
        contentDescription: p.content_description,
        images: getMultipleFileUrls(p, "images"),
        siteUrl: p.site_url,
      })),
    }}
  >
    // Générer projetsData avec navigation circulaire
    const projetsData = {};
    allProjets.forEach((p, index) => {
      const prevIndex = index === 0 ? allProjets.length - 1 : index - 1;
      const nextIndex = index === allProjets.length - 1 ? 0 : index + 1;
      projetsData[p.slug] = {
        theme: p.theme,
        backgroundImage: p.backgroundImage,
        title: p.title,
        description: p.description,
        contentDescription: p.contentDescription,
        images: p.images,
        siteUrl: p.siteUrl,
        prevId: allProjets[prevIndex].slug,
        nextId: allProjets[nextIndex].slug,
      };
    });

    // Mapping des couleurs par thème (exactement les mêmes que dans global.css)
    const themeColors = {
      blue: { primary: "#0080ff", secondary: "#00c3ff" },
      "les-12-fragments": { primary: "#32cd32", secondary: "#006400" },
      pink: { primary: "#ff1493", secondary: "#ff69b4" },
      "ca-va-trailer": { primary: "#fa0435", secondary: "#ff0000" },
      RBA: { primary: "#ff4500", secondary: "#ffd700" },
      "echo-safe": { primary: "#0414fa", secondary: "#00eaff" },
      omnisphere: { primary: "#3104fa", secondary: "#e100ff" },
    };

    // Animation fluide avec changement de thème et contenu sans rechargement
    document.addEventListener("DOMContentLoaded", () => {
      // Initialiser le thème au chargement de la page
      const htmlElement = document.documentElement;

      // Simplement définir le data-theme, le CSS global.css s'occupera du reste
      htmlElement.setAttribute("data-theme", currentTheme);
      const prevArrowWrapper = document.getElementById("prev-arrow-wrapper");
      const nextArrowWrapper = document.getElementById("next-arrow-wrapper");
      const heroDevice = document.getElementById("hero-device");
      const heroTitle = document.querySelector(".hero-title");
      const heroDescription = document.querySelector(".hero-description");
      const triangleRight = document.querySelector(".triangle-right");
      const backgroundComics = document.getElementById("background-comics");

      // Récupérer l'ID du projet actuel depuis l'URL
      const getCurrentProjetId = () => {
        const path = window.location.pathname;
        const match = path.match(/\/projets\/([^\/]+)/);
        return match ? match[1] : null;
      };

      const handleArrowClick = async (isPrev) => {
        const currentId = getCurrentProjetId();

        if (!currentId || !projetsData[currentId]) return;

        const currentProjet = projetsData[currentId];
        const nextId = isPrev ? currentProjet.prevId : currentProjet.nextId;

        if (!nextId || !projetsData[nextId]) return;

        const newProjet = projetsData[nextId];
        const newColors = themeColors[newProjet.theme];

        if (!heroDevice || !newColors) return;

        // Animation de sortie fluide de l'image uniquement
        heroDevice.style.opacity = "0";

        await new Promise((resolve) => setTimeout(resolve, 500));

        // Mise à jour du thème global (header, footer, boutons, titres)
        htmlElement.setAttribute("data-theme", newProjet.theme);

        // Mettre à jour le data-theme du header et footer
        const header = document.getElementById("header");
        const footer = document.querySelector("footer");
        if (header) {
          header.setAttribute("data-theme", newProjet.theme);
        }
        if (footer) {
          footer.setAttribute("data-theme", newProjet.theme);
        }

        // Mise à jour du contenu
        heroDevice.src = newProjet.backgroundImage;
        if (heroTitle) {
          heroTitle.textContent = newProjet.title;
        }
        if (heroDescription) {
          heroDescription.textContent = newProjet.description;
        }

        // Mise à jour du triangle de droite
        if (triangleRight) {
          triangleRight.style.background = newColors.primary;
        }

        // Mise à jour du gradient du BackgroundComics
        if (backgroundComics) {
          const gradientDiv = backgroundComics.querySelector(
            'div[style*="linear-gradient"]'
          );
          if (gradientDiv) {
            gradientDiv.style.background = `linear-gradient(90deg, ${newColors.secondary} 0%, ${newColors.primary} 100%)`;
          }
        }

        // Mise à jour des attributs data des flèches
        const prevWrapper = document.getElementById("prev-arrow-wrapper");
        const nextWrapper = document.getElementById("next-arrow-wrapper");
        if (prevWrapper) {
          prevWrapper.setAttribute("data-prev-projet", newProjet.prevId);
          const prevButton = prevWrapper.querySelector("button");
          if (prevButton) {
            prevButton.setAttribute("data-theme", newProjet.theme);
            prevButton.style.background = newColors.primary;
            prevButton.style.boxShadow = `-5px 5px 0 0 rgba(255, 255, 255, 1)`;
          }
        }
        if (nextWrapper) {
          nextWrapper.setAttribute("data-next-projet", newProjet.nextId);
          const nextButton = nextWrapper.querySelector("button");
          if (nextButton) {
            nextButton.setAttribute("data-theme", newProjet.theme);
            nextButton.style.boxShadow = `-5px 5px 0 0 ${newColors.primary}`;
            const nextSvg = nextButton.querySelector("svg");
            if (nextSvg) {
              nextSvg.style.color = newColors.primary;
            }
          }
        }

        // Mise à jour de la section contenu
        const contenuSection = document.getElementById("contenu");
        if (contenuSection) {
          contenuSection.setAttribute("data-theme", newProjet.theme);

          // Mettre à jour la description avec l'ID spécifique
          const descriptionDiv = document.getElementById("projet-description");
          if (descriptionDiv) {
            descriptionDiv.innerHTML = newProjet.contentDescription || "";
          }

          // Mettre à jour les images avec l'ID spécifique
          const imagesContainer = document.getElementById("projet-images-container");
          if (imagesContainer && newProjet.images) {
            imagesContainer.innerHTML = newProjet.images.map((image, index) => `
              <div>
                <img
                  src="${image}"
                  alt="${newProjet.title} - Mockup ${index + 1}"
                  class="w-full h-auto object-cover"
                />
              </div>
            `).join('');
          }

          // Mettre à jour le bouton site web avec l'ID spécifique
          const buttonContainer = document.getElementById("projet-button-container");
          if (buttonContainer) {
            if (newProjet.siteUrl) {
              buttonContainer.style.display = "block";
              const buttonLink = buttonContainer.querySelector("a");
              if (buttonLink) {
                buttonLink.href = newProjet.siteUrl;
                buttonLink.setAttribute("data-theme", newProjet.theme);
              }
            } else {
              buttonContainer.style.display = "none";
            }
          }
        }

        // Mise à jour du bandeau défilant
        const bannerContent = document.getElementById("banner-content");
        const projetBanner = document.getElementById("projet-banner");
        if (bannerContent) {
          const newBannerHTML = Array.from({ length: 20 }).map(() => `
            <span class="text-white font-primary text-2xl md:text-3xl italic transform -rotate-2 banner-title">
              ${newProjet.title}
            </span>
            <span class="text-4xl" style="color: ${newColors.primary};">★</span>
          `).join('');
          bannerContent.innerHTML = newBannerHTML;
        }
        if (projetBanner) {
          projetBanner.style.borderColor = newColors.primary;
        }

        // Mise à jour de l'URL sans rechargement
        window.history.pushState({}, "", `/projets/${nextId}`);
        document.title = `${newProjet.title} - Portfolio Bryan Thierry`;

        // Animation d'entrée de l'image
        await new Promise((resolve) => setTimeout(resolve, 50));
        heroDevice.style.opacity = "1";
      };

      // Attacher les event listeners
      if (prevArrowWrapper) {
        prevArrowWrapper.addEventListener("click", () =>
          handleArrowClick(true)
        );
      }
      if (nextArrowWrapper) {
        nextArrowWrapper.addEventListener("click", () =>
          handleArrowClick(false)
        );
      }
    });
  </script>

  <!-- Section Contenu -->
  <section id="contenu" class="pt-8 pb-35" style="background: var(--b1); transition: background-color 0.3s ease, color 0.3s ease;" data-theme={projet.theme}>
    <div class="mx-4 md:mx-8 lg:mx-16">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
        <!-- Contenu texte sticky -->
        <div class="lg:sticky lg:top-8">
          <div>
            <h2 class="font-primary text-4xl mb-6 transform -rotate-1">
              DESCRIPTION
            </h2>
            <div
              id="projet-description"
              class="text-lg leading-relaxed mb-8"
              style="color: var(--bc); transition: color 0.3s ease;"
              set:html={projet.content_description}
            />
          </div>

          <!-- Bouton vers le site (si disponible) -->
          {
            projet.site_url && (
              <div id="projet-button-container" class="text-center pt-8">
                <Button
                  href={projet.site_url}
                  className="font-primary text-lg px-8 py-4"
                  theme={projet.theme as any}
                >
                  VOIR LE SITE FINAL
                </Button>
              </div>
            )
          }
        </div>

        <!-- Images du projet -->
        <div id="projet-images-container" class="space-y-8 pb-20">
          {
            imagesUrls.map((image, index) => (
              <div>
                <img
                  src={image}
                  alt={`${projet.title} - Mockup ${index + 1}`}
                  class="w-full h-auto object-cover"
                />
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </section>
</Layout>
