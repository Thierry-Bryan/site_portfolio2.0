---
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/Button.astro";
import BackgroundComics from "../../components/BackgroundComics.astro";
import ArrowButton from "../../components/ArrowButton.astro";
import ProjetBanner from "../../components/ProjetBanner.astro";
import {
  getProjets,
  getProjetBySlug,
  getFileUrl,
  getMultipleFileUrls,
  getNextProjet,
  getPreviousProjet,
} from "../../utils/pb.ts";

// Générer les routes statiques pour tous les projets
export async function getStaticPaths() {
  const projets = await getProjets();
  return projets.map((projet) => ({
    params: { id: projet.slug },
  }));
}

// Récupérer le slug depuis les paramètres de l'URL
const { id } = Astro.params;

// Récupérer les données du projet
const projet = await getProjetBySlug(id);
const nextProjet = await getNextProjet(id);
const previousProjet = await getPreviousProjet(id);

// Si le projet n'existe pas, rediriger vers la page d'accueil
if (!projet) {
  return Astro.redirect("/");
}

// Récupérer les URLs des images
const heroImageUrl = getFileUrl(projet, projet.hero_image);
const imagesUrls = getMultipleFileUrls(projet, "images");

// Récupérer les technologies du projet depuis expand
const projetTechnologies = projet.expand?.technologies || [];
---

<Layout
  theme={projet.theme as any}
  title={`${projet.title} - Portfolio Bryan Thierry`}
>
  <!-- Hero Section -->
  <section
    class="relative h-[calc(120vh-7rem)] flex items-stretch overflow-hidden"
  >
    <div class="w-full h-full relative">
      <!-- Zone gauche : Texte sur fond avec angle prononcé (desktop uniquement) -->
      <div
        class="hidden md:flex absolute left-0 top-0 h-full flex-col justify-center pl-12 md:pl-16 lg:pl-20 pr-8 py-12 w-[35%] min-w-[340px] z-30"
      >
        <div class="absolute inset-0 -z-10 shadow-left clip-hero-left"></div>
        <h1
          class="hero-title text-4xl md:text-5xl lg:text-7xl mb-5 md:mb-6 leading-[0.95] transition-colors duration-700 text-color-p transform-rotate-title"
        >
          {projet.title}
        </h1>
        <p
          class="hero-description text-sm md:text-base lg:text-lg font-medium max-w-md leading-relaxed transition-colors duration-700 text-color-bc"
        >
          {projet.hero_description}
        </p>
      </div>

      <!-- Zone centrale : comics + device (desktop uniquement) -->
      <div
        class="hidden md:flex absolute left-[38%] top-0 h-full items-center justify-center w-[60%] z-20 clip-hero-center"
        id="hero-center"
      >
        <!-- Background pattern comics -->
        <div
          class="absolute inset-0 w-full h-full overflow-visible transition-all duration-700"
          id="background-comics"
        >
          <BackgroundComics theme={projet.theme as any} />
        </div>
      </div>

      <!-- Background comics plein écran mobile uniquement -->
      <div
        class="md:hidden absolute inset-0 w-full h-full overflow-visible transition-all duration-700 z-10"
        id="background-comics-mobile"
      >
        <BackgroundComics theme={projet.theme as any} />
      </div>

      <!-- Titre mobile en blanc, positionné en haut -->
      <h1
        class="md:hidden absolute top-32 left-0 right-0 z-30 text-5xl leading-tight text-center px-6 text-white"
      >
        {projet.title}
      </h1>

      <!-- Device image : centrée mobile, décalée desktop -->
      <div
        class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 md:-translate-x-[70px] z-20 md:z-22"
      >
        <img
          src={heroImageUrl}
          alt={projet.title}
          class="block mx-auto w-[100vw] max-w-[420px] max-h-[500px] md:max-h-[280px] lg:max-h-[360px] h-auto transition-opacity duration-500 drop-shadow-hero"
          id="hero-device"
        />
      </div>

      <!-- Zone droite : triangle avec angle prononcé (desktop uniquement) -->
      <div
        class="triangle-right hidden md:block absolute right-0 top-0 h-full w-[25%] min-w-[160px] z-25 pointer-events-none transition-all duration-700 card-bg-p clip-hero-right"
      >
        <div class="absolute inset-0 -z-10 shadow-right clip-triangle-right">
        </div>
      </div>

      <!-- Flèches de navigation : centrées mobile, positionnées desktop -->
      <div
        class="absolute bottom-24 left-8 md:bottom-20 md:left-[35%] z-40 cursor-pointer"
        id="prev-arrow-wrapper"
        data-prev-projet={previousProjet?.slug || ""}
      >
        <ArrowButton
          direction="prev"
          dataAttribute={previousProjet?.slug || ""}
          theme={projet.theme as any}
        />
      </div>
      <div
        class="absolute bottom-24 right-8 md:bottom-20 md:right-[17%] z-40 cursor-pointer"
        id="next-arrow-wrapper"
        data-next-projet={nextProjet?.slug || ""}
      >
        <ArrowButton
          direction="next"
          dataAttribute={nextProjet?.slug || ""}
          theme={projet.theme as any}
        />
      </div>
    </div>
  </section>

  <!-- Bandeau de défilement du nom du projet -->
  <ProjetBanner title={projet.title} theme={projet.theme as any} />

  <script>
    import {
      generateProjetsData,
      initializeProjetTheme,
      setupArrowListeners,
      listenThemeChanges,
    } from "../../scripts/projet-navigation";

    const currentTheme =
      document.documentElement.dataset.currentTheme || "ca-va-trailer";
    const allProjetsData = JSON.parse(
      document.documentElement.dataset.allProjets || "[]"
    );

    document.addEventListener("DOMContentLoaded", () => {
      // Générer projetsData avec navigation circulaire
      const projetsData = generateProjetsData(allProjetsData);

      // Initialiser le thème du projet
      initializeProjetTheme(currentTheme);

      // Configurer les event listeners pour les flèches
      setupArrowListeners(projetsData, currentTheme);

      // Écouter les changements de thème avec projetsData pour récupérer le thème actuel
      listenThemeChanges(projetsData);
    });
  </script>
  <script
    is:inline
    define:vars={{
      currentTheme: projet.theme,
      allProjets: (await getProjets()).map((p) => ({
        slug: p.slug,
        theme: p.theme,
        backgroundImage: getFileUrl(p, p.hero_image),
        title: p.title.toUpperCase(),
        description: p.hero_description,
        contentDescription: p.content_description,
        images: getMultipleFileUrls(p, "images"),
        siteUrl: p.site_url,
        technologies: p.expand?.technologies || [],
      })),
    }}
    data-projet-init
  >
    // Stocker les données pour le script
    document.documentElement.dataset.currentTheme = currentTheme;
    document.documentElement.dataset.allProjets = JSON.stringify(allProjets);
  </script>

  <!-- Section Contenu -->
  <section
    id="contenu"
    class="pt-8 pb-35 card-bg-b1 transition-bg-color"
    data-theme={projet.theme}
  >
    <div class="mx-4 md:mx-8 lg:mx-16">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
        <!-- Contenu texte sticky -->
        <div class="lg:sticky lg:top-8">
          <div>
            <div class="flex flex-wrap items-center gap-4 mb-6">
              <h2 class="font-primary text-4xl transform -rotate-1 m-0">
                DESCRIPTION
              </h2>
              <div id="projet-technologies" class="flex flex-wrap gap-2">
                {
                  projet.expand?.technologies &&
                  projet.expand.technologies.length > 0
                    ? projet.expand.technologies.map((tech: any) => (
                        <span class="px-2 py-1 text-xs font-secondary border border-(--bc) text-(--bc)">
                          {tech.name}
                        </span>
                      ))
                    : null
                }
              </div>
            </div>
            <div
              id="projet-description"
              class="text-lg leading-relaxed mb-8 text-color-bc transition-color"
              set:html={projet.content_description}
            />
          </div>

          <!-- Bouton vers le site (si disponible) -->
          {
            projet.site_url && (
              <div id="projet-button-container" class="text-center pt-8">
                <Button
                  href={projet.site_url}
                  className="font-primary text-lg px-8 py-4"
                  theme={projet.theme as any}
                  target="_blank"
                >
                  VOIR LE SITE FINAL
                </Button>
              </div>
            )
          }
        </div>

        <!-- Images du projet -->
        <div id="projet-images-container" class="space-y-8 pb-20">
          {
            imagesUrls.map((image, index) => (
              <div>
                <img
                  src={image}
                  alt={`${projet.title} - Mockup ${index + 1}`}
                  class="w-full h-auto object-cover"
                />
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </section>
</Layout>
