---
import Layout from "../../layouts/Layout.astro";
import BackgroundComics from "../../components/BackgroundComics.astro";
import { pb, getFileUrl } from "../../utils/pb.ts";

// R√©cup√©rer les tags depuis PocketBase
const tags = await pb.collection("tags").getFullList({
  sort: "name",
});

// R√©cup√©rer les projets avec leurs relations
const projets = await pb.collection("projets").getFullList({
  sort: "order",
  expand: "tags,technologies",
});

// Pr√©parer les options de filtre (Tous + les tags)
const filterOptions = ["Tous", ...tags.map((tag) => tag.name)];
---

<Layout title="Mes Projets" theme="ca-va-trailer">
  <section class="bg-(--b1) min-h-screen py-30 px-4 md:px-6">

    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="flex items-center justify-center mb-12">
        <h2 class="text-4xl md:text-6xl text-(--bc) font-primary">MES PROJETS</h2>
      </div>

      <!-- Filtres et Vue -->
      <div
        class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12"
      >
        <!-- Filtres de type -->
        <div
          class="flex flex-wrap gap-3 justify-center md:justify-start"
          id="type-filters"
        >
          {
            filterOptions.map((filterName) => (
              <button
                class="filter-btn px-6 py-2 border-2 border-(--bc) bg-(--b1) text-(--bc) font-primary cursor-pointer transition-all duration-300 hover:bg-(--p) hover:text-(--b1) hover:border-(--p)"
                data-type={filterName}
              >
                {filterName}
              </button>
            ))
          }
        </div>

        <!-- Toggle vue grille/ligne -->
        <div class="flex gap-2 p-1 bg-(--b1) border-2 border-(--bc)">
          <button
            id="grid-view-btn"
            class="view-btn active px-4 py-2 transition-all duration-300"
            aria-label="Vue grille"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <rect x="3" y="3" width="7" height="7" rx="1"></rect>
              <rect x="14" y="3" width="7" height="7" rx="1"></rect>
              <rect x="14" y="14" width="7" height="7" rx="1"></rect>
              <rect x="3" y="14" width="7" height="7" rx="1"></rect>
            </svg>
          </button>
          <button
            id="list-view-btn"
            class="view-btn px-4 py-2 transition-all duration-300"
            aria-label="Vue liste"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <line x1="8" y1="6" x2="21" y2="6" stroke-width="2"></line>
              <line x1="8" y1="12" x2="21" y2="12" stroke-width="2"></line>
              <line x1="8" y1="18" x2="21" y2="18" stroke-width="2"></line>
              <rect x="3" y="4" width="2" height="4" rx="1"></rect>
              <rect x="3" y="10" width="2" height="4" rx="1"></rect>
              <rect x="3" y="16" width="2" height="4" rx="1"></rect>
            </svg>
          </button>
        </div>
      </div>

      <!-- Grille de projets -->
      <div
        id="projets-container"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-4 place-items-center transition-all duration-300"
      >
        {
          projets.map((projet) => {
            // R√©cup√©rer les tags depuis expand
            const projetTags = projet.expand?.tags || [];
            // Construire une cha√Æne de tags s√©par√©s par espaces (plus simple √† filtrer)
            const tagTokens = projetTags
              .map((tag: any) => (tag?.name || "").trim())
              .filter(Boolean);
            const tagNames = tagTokens.join(" ");
            const tagNamesLower = tagTokens.map((t: string) => t.toLowerCase()).join(" ");
            
            // R√©cup√©rer les technologies depuis expand
            const projetTechnologies = projet.expand?.technologies || [];

            return (
              <a
                href={`/projets/${projet.slug}`}
                class="projet-card block w-full max-w-[350px]"
                data-tags={tagNames}
                data-tags-lower={tagNamesLower}
              >
                {/* Vue grille - avec BackgroundComics et bordure */}
                <div class="grid-view-content border-2 border-(--bc) bg-(--b1) h-full flex flex-col group">
                  <div
                    class="w-full h-[220px] flex items-center justify-center overflow-visible relative cursor-pointer"
                    data-theme={projet.theme}
                  >
                    <BackgroundComics theme={projet.theme} />
                    <img
                      src={projet.hero_image ? getFileUrl(projet, projet.hero_image) : "/images/placeholder.webp"}
                      alt={projet.title}
                      class="absolute z-10 h-[220px] object-cover drop-shadow-2xl transform transition-all duration-300 group-hover:h-[250px]"
                    />
                  </div>
                  {/* Description sous l'image en mode grille */}
                  <div class="p-4 flex-1 flex flex-col">
                    <h3 class="text-xl font-primary text-(--bc) mb-2">
                      {projet.title}
                    </h3>
                    <p class="text-sm font-secondary text-(--bc) mb-3 flex-1">
                      {projet.subtitle || ""}
                    </p>
                    <div class="flex flex-wrap gap-2">
                      {projetTechnologies.map((tech: any) => (
                        <span class="px-2 py-1 text-xs font-secondary border border-(--bc) text-(--bc)">
                          {tech.name}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Vue liste - rectangle horizontal */}
                <div class="list-view-content hidden">
                  <div class="flex items-center bg-(--b1) border-2 border-(--bc) overflow-hidden group h-[180px]">
                    {/* Image √† gauche avec BackgroundComics */}
                    <div
                      class="w-[250px] h-full flex items-center justify-center overflow-visible relative shrink-0"
                      data-theme={projet.theme}
                    >
                      <BackgroundComics theme={projet.theme} />
                      <img
                        src={projet.hero_image ? getFileUrl(projet, projet.hero_image) : "/images/placeholder.webp"}
                        alt={projet.title}
                        class="absolute z-10 h-40 object-cover drop-shadow-2xl transform transition-all duration-300 group-hover:h-[180px]"
                      />
                    </div>
                    {/* Contenu texte √† droite */}
                    <div class="flex-1 p-6">
                      <h3 class="text-2xl font-primary text-(--bc) mb-2">
                        {projet.title}
                      </h3>
                      <p class="text-sm font-secondary text-(--bc) mb-3">
                        {projet.subtitle || ""}
                      </p>
                      <div class="flex flex-wrap gap-2">
                        {projetTechnologies.map((tech: any) => (
                          <span class="px-2 py-1 text-xs font-secondary border border-(--bc) text-(--bc)">
                            {tech.name}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            );
          })
        }
        
        <!-- Projet √Ä venir -->
        <div class="projet-card projet-a-venir block w-full max-w-[350px]" data-tags="">
          <div class="grid-view-content border-2 border-(--bc) bg-(--b1) h-full flex items-center justify-center min-h-[220px]">
            <span class="text-(--bc) text-2xl font-primary">√Ä VENIR</span>
          </div>
          <div class="list-view-content hidden">
            <div class="coming-soon-list flex items-center justify-center bg-(--b1) border-2 border-(--bc) h-[180px] w-full">
              <span class="text-(--bc) text-2xl font-primary">√Ä VENIR</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Message si aucun projet -->
      <div
        id="no-results"
        class="hidden text-center py-20 font-secondary text-xl text-(--bc)"
      >
        Aucun projet trouv√© pour ce filtre üò¢
      </div>
    </div>
  </section>
</Layout>

<style>
  .filter-btn {
    transition: all 0.3s ease;
  }

  .filter-btn.active {
    background: var(--p);
    color: var(--b1);
    border-color: var(--p);
    box-shadow: 3px 3px 0px var(--bc);
  }

  .view-btn {
    color: var(--bc);
  }

  .view-btn.active {
    background: var(--p);
    color: var(--b1);
  }

  /* Alignement grille - hauteur uniforme */
  #projets-container.grid {
    align-items: stretch;
  }

  .projet-card {
    display: flex;
    height: 100%;
  }

  .grid-view-content {
    display: flex;
    flex-direction: column;
    width: 100%;
  }

  /* Vue liste - projets en rectangles horizontaux */
  .list-view {
    display: flex !important;
    flex-direction: column !important;
    gap: 1rem !important;
    max-width: 900px !important;
    width: 100% !important;
    margin: 0 auto !important;
    padding: 0 1rem !important;
  }

  .list-view .projet-card {
    max-width: none !important;
    width: 100% !important;
    display: block !important;
  }

  .list-view .grid-view-content {
    display: none !important;
  }

  .list-view .list-view-content {
    display: block !important;
    width: 100% !important;
  }

  .list-view .list-view-content > div {
    width: 100% !important;
  }

  /* Forcer le masquage en mode liste comme en grille */
  .projet-card.is-hidden {
    display: none !important;
  }



  @media (max-width: 768px) {
    .list-view .list-view-content > div {
      flex-direction: column;
      height: auto !important;
    }

    .list-view .list-view-content > div > div:first-child {
      order: 2;
    }

    .list-view .list-view-content > div > div:last-child {
      width: 100% !important;
      height: 220px;
      order: 1;
    }

    /* Garder le texte centr√© pour la carte "√Ä venir" en vue liste sur mobile */
    .list-view .coming-soon-list {
      flex-direction: row !important;
      height: 180px !important;
    }
  }
</style>

<script>
  // @ts-nocheck
  // Script simplifi√© : utilise style.display pour cacher/montrer
  const filterBtns = Array.from(document.querySelectorAll('.filter-btn'));
  const projetCards = Array.from(document.querySelectorAll('.projet-card'));
  const noResults = document.getElementById('no-results');
  const cardAVenir = document.querySelector('.projet-a-venir');

  /** @type {(tag: string) => void} */
  const applyFilter = (tag) => {
    const wanted = (tag || '').toLowerCase();
    let visible = 0;
    projetCards.forEach(card => {
      if (card.classList.contains('projet-a-venir')) {
        card.classList.remove('is-hidden');
        card.removeAttribute('style');
        card.setAttribute('aria-hidden', 'false');
        return; // ne compte pas dans visible
      }
      const tags = (card.getAttribute('data-tags-lower') || '').toLowerCase().split(/\s+/).filter(Boolean);
      const match = wanted === 'tous' || tags.includes(wanted);
      if (match) {
        card.classList.remove('is-hidden');
        card.removeAttribute('style');
        card.setAttribute('aria-hidden', 'false');
        visible++;
      } else {
        card.classList.add('is-hidden');
        card.setAttribute('style', 'display: none !important;');
        card.setAttribute('aria-hidden', 'true');
      }
    });
    if (noResults) {
      noResults.classList.toggle('hidden', visible !== 0);
    }
  }

  // Initialisation
  if (filterBtns[0]) {
    filterBtns[0].classList.add('active');
    applyFilter(filterBtns[0].getAttribute('data-type'));
  }

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilter(btn.getAttribute('data-type'));
    });
  });

  // Vue grille / liste (inchang√© sauf style.display si n√©cessaire)
  const gridViewBtn = document.getElementById('grid-view-btn');
  const listViewBtn = document.getElementById('list-view-btn');
  const projetsContainer = document.getElementById('projets-container');

  /** @type {(mode: 'grid'|'list') => void} */
  const setView = (mode) => {
    if (!projetsContainer) return;
    if (mode === 'grid') {
      projetsContainer.classList.remove('list-view');
      gridViewBtn?.classList.add('active');
      listViewBtn?.classList.remove('active');
    } else {
      projetsContainer.classList.add('list-view');
      listViewBtn?.classList.add('active');
      gridViewBtn?.classList.remove('active');
    }
  }
  gridViewBtn?.addEventListener('click', () => setView('grid'));
  listViewBtn?.addEventListener('click', () => setView('list'));
</script>
